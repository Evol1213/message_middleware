<!DOCTYPE html>
<html ng-app="APP">
	<head>
		<meta charset="utf-8" />
		<link rel="stylesheet" href="css/bootstrap.css">
		<link rel="stylesheet" href="css/matrix-style.css">
  		<style>
  			body {
          padding-top: 40px;
          padding-bottom: 40px;
          background-color: #f5f5f5;
        }
        form {
          margin-top: 100px;
        }
  		</style>
  	</head>

  	<body ng-controller="testCtrl">
      <div class="container">
        <div class="span10">
        	<div class="quick-actions_homepage">
        		<ul class="quick-actions">
			        <li class="bg_lb">
			        	<a href="#"> 
			        		<i class="icon-inbox"></i> 
			        		<span class="label label-important" ng-if="msgTotal">{{msgTotal}}</span>
			        		 消息 
			        	</a>
			        </li>
			    </ul>
        	</div>
        </div>

        <form class="form-horizontal container">
			<div class="control-group">
				<label class="control-label" for="id">目标</label>
				<div class="controls">
				  <input id="id" type="text" ng-model="form.to" placeholder="用户id" />
				</div>
			</div>
			<div class="control-group">
				<label class="control-label" for="title">标题</label>
				<div class="controls">
				  <input id="title" type="text" ng-model="form.title" placeholder="标题" />
				</div>
			</div>
			<div class="control-group">
				<label class="control-label" for="data">消息</label>
				<div class="controls">
				  <textarea id="data" ng-model="form.message" placeholder="消息"></textarea>
				</div>
			</div>

			<div class="control-group">
				<div class="controls">
					<button class="btn btn-success" ng-click="send()" ng-disabled="loading">发送</button>
					<button class="btn btn-warning" ng-click="initSocket()" ng-disabled="reconnection">重连</button>
				</div>
			</div>
        </form>
      </div>
  	</body>
    
    <script src="js/jquery.js"></script>
  	<script src="js/angular.js"></script>
  	<script src="js/bootstrap.js"></script>
  	<script src="js/angular-strap.js"></script>
    <script src="js/socket.io/socket.io.js"></script>
  	<script>
		var APP = angular.module('APP', ['$strap.directives']);

  		APP.controller('testCtrl', function($scope){
			
			$scope.sio = null;
			$scope.reconnection = false;
  			$scope.initSocket = function(){
  				$scope.reconnection = true;
  				console.log("test");

  				var options = {
		  			"reconnect": false
		  			, "force new connection": true
		  		};

	  			//注意这里把token以url参数的形式绑定在socket上，用于服务器端进行认证
				$scope.sio = io.connect("http://localhost:8080/msg?auth=123", options); 
				
				//todo 要实现所有的错误事件监听，保证消息发送失败后的提示
				$scope.sio.on("connect_failed", function(err){
	                console.log("connect_failed: " + err);

	                $scope.msgTotal = 0;
	                $scope.reconnection = false;
	                $scope.$root.$$phase || $scope.$apply();
	            });
	            $scope.sio.on("error", function(err){
					console.log("error: " + err);
					
					$scope.msgTotal = 0;
					$scope.reconnection = false;
					$scope.$root.$$phase || $scope.$apply();
				});
				$scope.sio.on("disconnect", function(){
					console.log("disconnect");
					
					$scope.msgTotal = 0;
					$scope.reconnection = false;
					$scope.$root.$$phase || $scope.$apply();
				});

	            //获取当前未读消息数
	            $scope.sio.on("news-total", function(data){
	            	$scope.msgTotal += data[0] + data[1] + data[2];
	            	$scope.$root.$$phase || $scope.$apply();
	            });
  			};

			$scope.form = {
				to: 7
				, title: "test"
				, message: "中文测试"
			};

			$scope.msgTotal = 0;
			$scope.loading = false;
			//用户发送消息
			$scope.send = function(){
				$scope.sio.emit("send", {
                    to: $scope.form.to
                    , title: $scope.form.title
                    , message: $scope.form.message
                }, function(response){
                	//检查响应

                });
			};
  		});
  	</script>
</html>